{% extends "base.html" %}
{% block title %}Quality Gates â€” {{ state.project.name }}{% endblock %}

{% block center_pane %}
<div class="py-4">
    <div class="text-center mb-4">
        <h5>Quality Gates</h5>
        <p class="text-muted small">Final 5-gate quality validation on the complete document.</p>
    </div>

    {% if error %}
    <div class="alert alert-danger mx-auto" style="max-width: 560px;">{{ error }}</div>
    {% endif %}

    {% if final_report and final_report.ran_at %}
    <div class="card mx-auto mb-3" style="max-width: 620px;">
        <div class="card-header d-flex justify-content-between">
            <span>Final Quality Report</span>
            {% if final_report.all_passed %}
            <span class="badge bg-success">ALL PASSED</span>
            {% else %}
            <span class="badge bg-danger">FAILED</span>
            {% endif %}
        </div>
        <div class="card-body">
            <small class="text-muted">Ran at: {{ final_report.ran_at }}</small>
            {% if report_text %}
            <pre class="mt-3 p-3 bg-light rounded small" style="white-space: pre-wrap;">{{ report_text }}</pre>
            {% endif %}
        </div>
    </div>

    {% if final_report.all_passed and state.current_phase == 'quality_gates' %}
    <div class="text-center">
        <form action="/projects/{{ slug }}/quality-gates/advance" method="POST">
            <button type="submit" class="btn btn-success">Advance to Final Assembly</button>
        </form>
    </div>
    {% elif not final_report.all_passed %}
    <div class="text-center">
        <a href="/projects/{{ slug }}/chapter-build" class="btn btn-outline-warning">Return to Chapter Build</a>
    </div>
    {% endif %}

    {% elif state.current_phase == 'quality_gates' %}
    <div class="text-center">
        <form action="/projects/{{ slug }}/quality-gates/run" method="POST" class="mb-3">
            <button type="submit" class="btn btn-primary">Run Final Quality Gates</button>
        </form>
    </div>

    {% else %}
    <!-- Project is past this phase -->
    <div class="text-center">
        <div class="alert alert-info mx-auto d-inline-block" style="max-width: 500px;">
            <p class="mb-2">Quality gates have already been completed for this project.</p>
            {% if state.current_phase == 'complete' %}
            <a href="/projects/{{ slug }}/complete" class="btn btn-primary btn-sm">View Project Summary</a>
            {% else %}
            <a href="/projects/{{ slug }}" class="btn btn-outline-secondary btn-sm">Go to Current Phase</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block right_pane_title %}Quality Gates{% endblock %}
{% block right_pane_content %}
<p class="text-muted small">Quality gates validate the complete document against 5 criteria:</p>
<ul class="text-muted small">
    <li>Structural completeness</li>
    <li>Content depth & specificity</li>
    <li>Technical accuracy</li>
    <li>Consistency across chapters</li>
    <li>Implementation readiness</li>
</ul>
{% if final_report and final_report.ran_at %}
<hr>
<p class="text-muted small"><strong>Status:</strong>
    {% if final_report.all_passed %}
    <span class="text-success">All Passed</span>
    {% else %}
    <span class="text-danger">Failed</span>
    {% endif %}
</p>
{% endif %}
{% endblock %}
